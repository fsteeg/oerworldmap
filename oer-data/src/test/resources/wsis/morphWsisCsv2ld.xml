<?xml version="1.0" encoding="UTF-8"?>
<metamorph xmlns="http://www.culturegraph.org/metamorph"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1">
	<vars>
		<!-- like turtle prefix -->
		<var name="schema:" value="http://schema.org/" />
		<var name="oer:" value="http://lobid.org/oer/" />
		<var name="foaf:" value="http://xmlns.com/foaf/0.1/" />
	</vars>
	<rules>
		<!-- uuid and id handling -->
		<combine name="@id" value="${idGenerated}">
			<if>
				<none>
					<data source="@idLookup">
						<regexp match=".+" />
					</data>
				</none>
			</if>
			<data source="2" name="idGenerated">
				<generate-uuid />
			</data>
		</combine>
		<data source="@idLookup" name="@id">
			<regexp match=".+" />
		</data>
		<combine name="@doIdLookup" value="${idLookup}">
			<data source="2" name="idLookup">
				<regexp match="(.*)" format="wsis${1}" />
			</data>
		</combine>
		<data source="@doIdLookup" name="@idLookup">
			<lookup in="internalId2uuidMap" />
		</data>
		<!-- set the ID's of the thing (@subjectUri) and the metadata of that thing 
			(@serviceSubjectAboutUri) -->
		<combine name="@subjectAboutUri" value="$[oer:]${subject}">
			<data source="@id" name="subject">
				<regexp match=".*" />
			</data>
		</combine>
		<data source="@subjectAboutUri" name="~rdf:subject" />
		<data source="@subjectUri" name="$[foaf:]primaryTopic" />
		<combine name="@subjectUri" value="${subjectUri}#!">
			<data source="@subjectAboutUri" name="subjectUri" />
		</combine>
		<data source="@subjectUri" name="~rdf:subject" />
		<!-- /set the ID's of the thing (@subjectUri) and the metadata of that 
			thing (@serviceSubjectAboutUri) -->
		<!-- /uuid and id handling -->
		<combine name="http://purl.org/dc/elements/1.1/identifier"
			value="wsis${idInternal}">
			<data source="2" name="idInternal" />
			<data source="@subjectUri" />
		</combine>
		<combine name="$[schema:]name" value="${name}">
			<data source="3" name="name" />
			<data source="@subjectUri" />
		</combine>
		<combine name="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
			value="$[schema:]Organization">
			<data source="@subjectUri" />
			<data source="8">
				<regexp match="C" />
			</data>
		</combine>
		<combine name="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
			value="$[schema:]Service">
			<data source="@subjectUri" />
			<data source="8">
				<regexp match="R" />
			</data>
		</combine>
		<combine name="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
			value="$[foaf:]Project">
			<data source="@subjectUri" />
			<data source="8">
				<regexp match="P" />
			</data>
		</combine>
		<combine name="$[schema:]url" value="${url}">
			<data source="5" name="url">
				<regexp match=".+" />
			</data>
			<data source="@subjectUri" />
		</combine>
		<combine name="$[schema:]description" value="${description}">
			<data source="4" name="description" />
			<data source="@subjectUri" />
		</combine>
		<combine name="$[schema:]email" value="${email}">
			<data source="6" name="email">
			<regexp match=".+" />
			</data>
			<data source="@subjectUri" />
		</combine>
		<combine name="@person" value="${person}">
			<data source="12" name="person">
			<split delimiter=","/> 
			</data>
		</combine>
		<combine name="$[schema:]city" value="${a}">
		<data source="@person" name="a">
		<regexp match="^..city..:..(.*).." format="${1}"/> 
	    </data>
		<data source="@subjectUri" />
			
		</combine>
		<!-- contact -->
		<combine name="@contactUrl" value="${a}" flushWith="record">
			<data source="ocw_website" name="a">
				<regexp match=".+" />
			</data>
		</combine>
		<combine name="@serviceUrlTmp" value="${a}">
			<data source="@serviceUrl" name="a">
				<regexp match=".+" />
			</data>
		</combine>
		<!-- generated ID -->
		<combine name="@idServiceUrl" value="${idGenerated}">
			<if>
				<none>
					<data source="@idServiceLookup">
						<regexp match=".+" />
					</data>
				</none>
			</if>
			<data source="@serviceUrl" name="idGenerated">
				<generate-uuid />
			</data>
		</combine>
		<!-- lookuped ID -->
		<data source="@idServiceLookup" name="@idServiceUrl">
			<regexp match=".+" />
		</data>
		<combine name="@doIdServiceLookup" value="${idServiceLookup}">
			<data source="@serviceUrl" name="idServiceLookup">
				<regexp match="(.*)" format="${1}" />
			</data>
		</combine>
		<data source="@doIdServiceLookup" name="@idServiceLookup">
			<lookup in="internalId2uuidMap" />
		</data>
		<!-- set the ID's of the thing (@serviceSubjectUri) and the metadata of 
			that thing (@serviceSubjectAboutUri) -->
		<combine name="@serviceSubjectAboutUri" value="$[oer:]${subject}">
			<data source="@idServiceUrl" name="subject">
				<regexp match=".*" />
			</data>
		</combine>
		<combine name="@serviceSubjectUri" value="${serviceSubjectUri}#!">
			<data source="@serviceSubjectAboutUri" name="serviceSubjectUri" />
		</combine>
		<combine name="$[schema:]providesService" value="${a}">
			<data source="@serviceSubjectUri" name="a">
				<regexp match=".+" />
			</data>
		</combine>
		<!-- /set the ID's of the thing (@serviceSubjectUri) and the metadata of 
			that thing (@serviceSubjectAboutUri) -->
		<!-- /uuid and id handling for the main oer -->
		<!-- /services -->
		<!-- geoLocation -->
		<combine name="@geoUuid" value="urn:uuid:${uuid}">
			<if>
				<data source="coordinates0" />
			</if>
			<data source="@id" name="uuid">
			</data>
		</combine>
		<data source="@geoUuid" name="$[schema:]geo" />
		<!-- temporarily set new subject id -->
		<combine name="~rdf:subject" value="${uuid}">
			<data source="@geoUuid" name="uuid" />
			<data source="@id" />
		</combine>
		<combine name="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
			value="http://schema.org/GeoCoordinates">
			<data source="@geoUuid" />
			<data source="@id" />
		</combine>
		<combine name="$[schema:]longitude" value="${long}">
			<data source="@geoUuid" />
			<data source="@id" />
			<data source="coordinates0" name="long" />
		</combine>
		<combine name="$[schema:]latitude" value="${lat}">
			<data source="@geoUuid" />
			<data source="@id" />
			<data source="coordinates1" name="lat" />
		</combine>
		<!-- set subject uri of oer anew -->
		<combine name="~rdf:subject" value="$[oer:]${subject}#!">
			<data source="coordinates1" />
			<data source="@id" name="subject">
			</data>
		</combine>
		<!-- /geoLocation -->
		<!-- ####################### -->
		<!-- ############### statistics -->
		<!-- ####################### -->
		<data source="_else" />
	</rules>
	<maps>
		<!-- tsv of concordance uuid<=>internalID -->
		<filemap name="internalId2uuidMap" files="internalId2uuid.tsv" />
	</maps>
</metamorph>
